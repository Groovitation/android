stages:
  - build
  - test
  - deploy

variables:
  ANDROID_COMPILE_SDK: "35"
  ANDROID_BUILD_TOOLS: "35.0.0"
  ANDROID_SDK_TOOLS: "11076708"

.android_setup: &android_setup
  image: eclipse-temurin:17-jdk
  before_script:
    - apt-get update -qq && apt-get install -y -qq wget unzip
    - export ANDROID_HOME="${PWD}/android-sdk"
    - mkdir -p $ANDROID_HOME/cmdline-tools
    - wget -q "https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_SDK_TOOLS}_latest.zip" -O cmdline-tools.zip
    - unzip -q cmdline-tools.zip -d $ANDROID_HOME/cmdline-tools
    - mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
    - export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
    - yes | sdkmanager --licenses > /dev/null 2>&1 || true
    - sdkmanager "platform-tools" "platforms;android-${ANDROID_COMPILE_SDK}" "build-tools;${ANDROID_BUILD_TOOLS}" > /dev/null
    - chmod +x ./gradlew

build:
  <<: *android_setup
  stage: build
  script:
    - ./gradlew assembleDebug --no-daemon
  artifacts:
    paths:
      - app/build/outputs/apk/debug/app-debug.apk
    expire_in: 1 week

test:
  <<: *android_setup
  stage: test
  script:
    - ./gradlew test --no-daemon
  artifacts:
    reports:
      junit: app/build/test-results/testDebugUnitTest/*.xml

lint:
  <<: *android_setup
  stage: test
  script:
    - ./gradlew lint --no-daemon
  artifacts:
    paths:
      - app/build/reports/lint-results-debug.html
    expire_in: 1 week
  allow_failure: true

deploy:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build
  before_script:
    - apk add --no-cache openssh-client rsync
    - mkdir -p ~/.ssh
    - echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H groovitation.blaha.io >> ~/.ssh/known_hosts 2>/dev/null || true
  script:
    - cp app/build/outputs/apk/debug/app-debug.apk groovitation.apk
    - rsync -avz groovitation.apk deploy@groovitation.blaha.io:/var/www/groovitation/public/android/
    - ssh deploy@groovitation.blaha.io "ln -sf /var/www/groovitation/public/android/groovitation.apk /var/www/groovitation/public/android/latest.apk"
  only:
    - main
  environment:
    name: production
    url: https://groovitation.blaha.io/android/groovitation.apk
