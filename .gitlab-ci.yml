stages:
  - build
  - test
  - deploy

variables:
  ANDROID_COMPILE_SDK: "35"
  ANDROID_BUILD_TOOLS: "35.0.0"
  ANDROID_SDK_TOOLS: "11076708"

# Shell executor setup - assumes Java is installed on runner
# Android SDK is downloaded per-job to android-sdk/ directory
.android_setup: &android_setup
  before_script:
    - echo "$GOOGLE_SERVICES_JSON" > app/google-services.json
    - export ANDROID_HOME="${PWD}/android-sdk"
    - mkdir -p $ANDROID_HOME/cmdline-tools
    - |
      if [ ! -d "$ANDROID_HOME/cmdline-tools/latest" ]; then
        wget -q "https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_SDK_TOOLS}_latest.zip" -O cmdline-tools.zip
        unzip -q cmdline-tools.zip -d $ANDROID_HOME/cmdline-tools
        mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
      fi
    - export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
    - yes | sdkmanager --licenses > /dev/null 2>&1 || true
    - sdkmanager "platform-tools" "platforms;android-${ANDROID_COMPILE_SDK}" "build-tools;${ANDROID_BUILD_TOOLS}" > /dev/null
    - chmod +x ./gradlew

build:
  <<: *android_setup
  stage: build
  script:
    - ./gradlew assembleDebug --no-daemon
  artifacts:
    paths:
      - app/build/outputs/apk/debug/app-debug.apk
    expire_in: 1 week

test:
  <<: *android_setup
  stage: test
  script:
    - ./gradlew test --no-daemon
  artifacts:
    reports:
      junit: app/build/test-results/testDebugUnitTest/*.xml

lint:
  <<: *android_setup
  stage: test
  script:
    - ./gradlew lint --no-daemon
  artifacts:
    paths:
      - app/build/reports/lint-results-debug.html
    expire_in: 1 week
  allow_failure: true

deploy:
  stage: deploy
  dependencies:
    - build
  variables:
    DEPLOY_HOST: "192.168.1.124"
  before_script:
    - mkdir -p ~/.ssh
    - echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
  script:
    - |
      ./scripts/generate-version-json.sh version.json
      VERSION_NAME=$(sed -n 's/.*"latest_version_name": *"\\([^"]*\\)".*/\\1/p' version.json)
      APK_NAME="groovitation-${VERSION_NAME}.apk"
      cp app/build/outputs/apk/debug/app-debug.apk "${APK_NAME}"
      cp app/build/outputs/apk/debug/app-debug.apk groovitation.apk
      rsync -avz "${APK_NAME}" groovitation.apk version.json ben@${DEPLOY_HOST}:/media/nvme/docker_volumes/groovitation-android/
  only:
    - main
  environment:
    name: production
    url: https://groovitation.blaha.io/android
